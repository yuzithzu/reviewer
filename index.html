<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PNLE PRO | FIREBASE EDITION</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>

    <style>
        /* ==================================================================================
           THEME & VARIABLES
           ================================================================================== */
        :root {
            --bg-body: #09090b;
            --bg-card: #18181b;
            --bg-input: #27272a;
            --border-color: #3f3f46;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --primary: #06b6d4; 
            --primary-hover: #0891b2; 
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.15);
            --radius-sm: 6px;
            --radius-md: 12px;
            --container-width: 1280px;
            --font-main: "Inter", sans-serif;
            --font-mono: "JetBrains Mono", monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; scroll-behavior: smooth; }
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            font-size: 16px;
            overflow-x: hidden;
            padding-bottom: 50px;
        }

        /* LAYOUT & UTILS */
        .wrapper { max-width: var(--container-width); margin: 0 auto; padding: 24px; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .hidden { display: none !important; }
        .text-mono { font-family: var(--font-mono); }
        .text-primary { color: var(--primary); }
        .text-error { color: var(--error); }
        .text-success { color: var(--success); }
        .text-muted { color: var(--text-muted); }
        .font-bold { font-weight: 700; }
        .gap-2 { gap: 8px; }
        
        /* COMPONENTS */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 24px; border-radius: var(--radius-sm); font-weight: 600;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
            font-family: var(--font-main); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-primary { background-color: var(--primary); color: #000; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--bg-input); color: var(--text-main); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        .btn-outline:hover, .btn-outline.active { border-color: var(--primary); color: var(--primary); background: rgba(6, 182, 212, 0.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-action { padding: 4px 8px; font-size: 0.7rem; margin-right: 4px; border-radius: 4px; }
        .btn-danger { background: var(--error-bg); color: var(--error); border: 1px solid var(--error); }
        .btn-warning { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--warning); }
        .btn-success { background: var(--success-bg); color: var(--success); border: 1px solid var(--success); }

        .input {
            width: 100%; padding: 14px 16px; background-color: var(--bg-input);
            border: 1px solid var(--border-color); border-radius: var(--radius-sm);
            color: var(--text-main); font-family: var(--font-main); outline: none;
        }
        .input:focus { border-color: var(--primary); }

        .card {
            background-color: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: var(--radius-md); padding: 32px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .grid-layout {
            display: grid; grid-template-columns: 1fr 350px; gap: 32px; margin-top: 32px;
        }
        @media (max-width: 968px) { .grid-layout { grid-template-columns: 1fr; } }

        /* HEADER */
        .header { border-bottom: 1px solid var(--border-color); padding-bottom: 24px; margin-bottom: 24px; }
        .brand-logo { font-family: var(--font-mono); font-size: 1.5rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .system-status { background: rgba(255,255,255,0.03); padding: 6px 16px; border-radius: 50px; border: 1px solid var(--border-color); font-size: 0.8rem; }
        .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--success); margin-right: 6px; }

        /* ADMIN TABLE */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { text-align: left; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; text-transform: uppercase; }
        .data-table td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .data-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* TOAST */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 16px 24px;
            background: var(--bg-card); border: 1px solid var(--border-color); border-left: 4px solid var(--primary);
            border-radius: var(--radius-sm); transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000; font-weight: 600; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: var(--error); }
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }

        /* ANIMATION */
        .fade-in { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* RESULT & TIMER STYLES */
        .result-badge {
            font-size: 4rem; font-weight: 900; font-family: var(--font-mono); margin-bottom: 10px;
            text-shadow: 0 0 30px currentColor;
        }
        .countdown-bar {
            height: 4px; background: var(--bg-input); width: 100%; margin-top: 20px; border-radius: 2px; overflow: hidden;
        }
        .countdown-fill {
            height: 100%; background: var(--primary); width: 100%;
            transition: width 1s linear;
        }
        
        .source-link {
            font-size: 0.8rem; margin-top: 10px; padding-top: 10px; 
            border-top: 1px dashed var(--border-color); color: var(--primary);
            font-family: var(--font-mono);
        }

        .set-selector {
            display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;
        }

    </style>
</head>

<body>
    <div id="toast" class="toast">
        <div id="toast-msg">Notification Message</div>
    </div>

    <div class="wrapper">
        <header class="header flex justify-between items-center">
            <div class="brand-logo">
                <span class="text-primary">PNLE</span> PRO <span style="font-size: 0.8rem; margin-left: 10px; color: var(--text-muted); font-weight: 400;">FIREBASE</span>
            </div>
            <div class="system-status">
                <span class="status-dot"></span> ONLINE <span style="margin: 0 8px; color: var(--border-color)">|</span> <span id="clock" class="text-mono">00:00:00</span>
            </div>
        </header>

        <main class="grid-layout">
            <section id="main-content">
                
                <div id="view-login" class="card fade-in">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 1.5rem; margin-bottom: 8px;">Reviewer Login</h2>
                        <p class="text-muted">Enter credentials to start the secure session.</p>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display:block; margin-bottom: 8px; font-size: 0.9rem;" class="text-muted">Username</label>
                        <input type="text" id="inp-user" class="input" placeholder="e.g. admin or student1" autocomplete="off" />
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display:block; margin-bottom: 8px; font-size: 0.9rem;" class="text-muted">Password</label>
                        <input type="password" id="inp-pass" class="input" placeholder="••••••••" />
                    </div>

                    <button id="btn-login" class="btn btn-primary" style="width: 100%;">START SESSION</button>
                    <p class="text-muted" style="font-size: 0.75rem; margin-top: 20px; text-align: center;">
                        Secured by Firebase Auth & Firestore
                    </p>
                </div>

                <div id="view-admin" class="card fade-in hidden">
                    <div class="flex justify-between items-center" style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <h2 class="text-primary">Admin Control Center</h2>
                            <p class="text-muted" style="font-size: 0.85rem;">User & Data Management</p>
                        </div>
                        <div class="flex gap-2">
                             <button id="btn-seed-data" class="btn btn-primary" style="font-size: 0.75rem;">⬆ UPLOAD QUESTIONS</button>
                             <button id="btn-admin-logout" class="btn btn-secondary text-xs">EXIT ADMIN</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px; font-size: 0.8rem; color: var(--text-muted); background: var(--bg-input); padding: 10px; border-radius: var(--radius-sm);">
                        <strong>NOTE:</strong> Click "Upload Questions" only once to populate your Firestore Database with the initial question set.
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="table-users">
                            <thead>
                                <tr>
                                    <th>Username / Email</th>
                                    <th>Status</th>
                                    <th>Security</th>
                                    <th>Controls</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-quiz" class="hidden fade-in"></div>

            </section>

            <aside class="sidebar fade-in" style="max-width: 350px;">
                <div class="card">
                    <div class="flex items-center gap-4" style="margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; background: var(--bg-input); border-radius: 50%; display: grid; place-items: center; color: var(--primary);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: 0.75rem;">CURRENT CANDIDATE</div>
                            <div id="display-username" class="font-bold text-primary">Guest</div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 10px;">
                            AUTO-LOGOUT PROTECTION: ACTIVE
                        </div>
                        <button id="btn-logout" class="btn btn-secondary" style="width: 100%; font-size: 0.8rem;">LOGOUT SESSION</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script type="module">
        // 1. IMPORT FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, addDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // 2. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCmd6vmuXUPslLJf0w7I518C8UIaO2DoAA",
            authDomain: "pnle-class.firebaseapp.com",
            projectId: "pnle-class",
            storageBucket: "pnle-class.firebasestorage.app",
            messagingSenderId: "1024768890816",
            appId: "1:1024768890816:web:28bf31d5ae67c679feda25",
            measurementId: "G-JLS5ZGFP3J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =======================================================
        // INITIAL DATA FOR SEEDING (Run once via Admin)
        // =======================================================
        const localQuestionPool = [
          // --- FUNDAMENTALS ---
          {
            question: "What is the legal age requirement to take the Philippine Nursing Board Exam?",
            choices: ["18 years old", "21 years old", "17 years old", "20 years old"],
            answer: "18 years old",
            rationale: "RA 9173 specifies 18 years as the minimum age.",
            reference: "RA 9173 Art. IV Sec 13"
          },
          {
            question: "Which government agency administers the PNLE?",
            choices: ["PRC", "DOH", "PNA", "CHED"],
            answer: "PRC",
            rationale: "Professional Regulation Commission regulates licensure exams.",
            reference: "www.prc.gov.ph"
          },
          {
            question: "In the nursing process, what comes after Assessment?",
            choices: ["Planning", "Diagnosis", "Implementation", "Evaluation"],
            answer: "Diagnosis",
            rationale: "ADPIE: Assessment, Diagnosis, Planning, Implementation, Evaluation.",
            reference: "Fundamentals of Nursing"
          },
          // --- MCN ---
          {
            question: "Which hormone is responsible for the ejection of milk?",
            choices: ["Oxytocin", "Prolactin", "Estrogen", "Progesterone"],
            answer: "Oxytocin",
            rationale: "Oxytocin causes the let-down reflex. Prolactin makes the milk.",
            reference: "Maternal & Child Nursing (Pillitteri)"
          },
          {
            question: "What is the normal fetal heart rate range?",
            choices: ["120-160 bpm", "100-140 bpm", "80-120 bpm", "140-180 bpm"],
            answer: "120-160 bpm",
            rationale: "Normal baseline FHR is typically 110-160 or 120-160 depending on the reference.",
            reference: "AWHONN Guidelines"
          },
          {
            question: "A woman who has given birth for the first time is called:",
            choices: ["Primipara", "Nullipara", "Multipara", "Primigravida"],
            answer: "Primipara",
            rationale: "Para indicates the number of births after viability.",
            reference: "MCN Terminology"
          },
          // --- MEDSURG ---
          {
             question: "Which is the primary prevention against Hepatitis B?",
             choices: ["Vaccination", "Antibiotics", "Physical Therapy", "Isolation"],
             answer: "Vaccination",
             rationale: "Immunization is primary prevention.",
             reference: "DOH National Immunization Program"
          },
          {
            question: "Which term refers to difficulty in breathing?",
            choices: ["Dyspnea", "Apnea", "Eupnea", "Tachypnea"],
            answer: "Dyspnea",
            rationale: "Dyspnea is subjective difficulty in breathing.",
            reference: "MedSurg Nursing (Brunner & Suddarth)"
          },
          {
            question: "What is the hallmark sign of pyloric stenosis?",
            choices: ["Projectile vomiting", "Currant jelly stool", "Ribbon-like stool", "Steatorrhea"],
            answer: "Projectile vomiting",
            rationale: "Projectile vomiting occurs shortly after feeding in pyloric stenosis.",
            reference: "Pediatric Nursing (Wong)"
          },
          {
            question: "What is the most common cause of COPD?",
            choices: ["Smoking", "Air pollution", "Genetics", "Infection"],
            answer: "Smoking",
            rationale: "Cigarette smoking is the leading cause of COPD.",
            reference: "WHO COPD Factsheet"
          },
          // --- PAL ---
          {
            question: "Who is considered the 'Mother of Modern Nursing'?",
            choices: ["Florence Nightingale", "Clara Barton", "Mary Jolley", "Lillian Wald"],
            answer: "Florence Nightingale",
            rationale: "She established the principles of modern nursing.",
            reference: "Nursing History"
          },
          {
            question: "What refers to the commission of an act that a prudent nurse would not do?",
            choices: ["Negligence", "Malpractice", "Assault", "Battery"],
            answer: "Negligence",
            rationale: "Negligence is failure to use such care as a reasonably prudent and careful person would use.",
            reference: "Nursing Jurisprudence"
          },
          // --- PHARMA ---
          {
            question: "What is the antidote for Acetaminophen overdose?",
            choices: ["Acetylcysteine", "Naloxone", "Atropine", "Vitamin K"],
            answer: "Acetylcysteine",
            rationale: "Mucomyst (Acetylcysteine) prevents liver damage.",
            reference: "Pharmacology (Katzung)"
          },
          {
            question: "Which medication is an example of an ACE inhibitor?",
            choices: ["Captopril", "Amlodipine", "Losartan", "Metoprolol"],
            answer: "Captopril",
            rationale: "Drugs ending in -pril are typically ACE inhibitors.",
            reference: "Pharmacology Classifications"
          },
           {
            question: "When administering insulin, which site has the fastest absorption?",
            choices: ["Abdomen", "Thigh", "Arm", "Buttocks"],
            answer: "Abdomen",
            rationale: "The abdomen provides the most rapid and consistent absorption.",
            reference: "Diabetes Care Guidelines"
          }
        ];

        // LOGIC VARIABLES
        let dbQuestionPool = []; // Will be filled from Firestore
        let seenIndices = new Set();
        let activeQuizSet = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentSetSize = 5; // Default set size
        let questionTimerInterval;
        let breakInterval;

        // =======================================================
        // DATA FETCHING
        // =======================================================
        async function fetchQuestionsFromDB() {
            try {
                const querySnapshot = await getDocs(collection(db, "questions"));
                dbQuestionPool = [];
                querySnapshot.forEach((doc) => {
                    dbQuestionPool.push(doc.data());
                });
                console.log(`Loaded ${dbQuestionPool.length} questions from Firestore.`);
            } catch (e) {
                console.error("Error loading questions:", e);
                showToast("Error loading data", "error");
            }
        }

        async function seedDatabase() {
            if(!confirm("This will upload local questions to Firebase. Continue?")) return;
            const btn = document.getElementById('btn-seed-data');
            btn.disabled = true;
            btn.innerText = "UPLOADING...";
            
            try {
                let count = 0;
                for (const q of localQuestionPool) {
                    await addDoc(collection(db, "questions"), q);
                    count++;
                }
                showToast(`Successfully uploaded ${count} questions!`, "success");
                btn.innerText = "UPLOAD COMPLETE";
                await fetchQuestionsFromDB(); // Reload local pool
            } catch (e) {
                console.error(e);
                showToast("Upload failed", "error");
                btn.disabled = false;
                btn.innerText = "⬆ UPLOAD QUESTIONS";
            }
        }

        // =======================================================
        // QUIZ LOGIC
        // =======================================================
        
        async function startQuizSequence() {
            // Ensure data is loaded
            if (dbQuestionPool.length === 0) {
                document.getElementById('view-quiz').innerHTML = `<div class="card" style="text-align:center;">
                    <h2>Loading Database...</h2>
                    <p class="text-muted">Fetching questions from cloud.</p>
                </div>`;
                await fetchQuestionsFromDB();
                if(dbQuestionPool.length === 0) {
                     document.getElementById('view-quiz').innerHTML = `<div class="card" style="text-align:center;">
                        <h2 class="text-error">No Questions Found</h2>
                        <p class="text-muted">Please ask Admin to click "Upload Questions".</p>
                    </div>`;
                    return;
                }
            }
            generateNewQuizSet(currentSetSize);
            renderQuestion(0);
        }

        function generateNewQuizSet(size) {
            let availableIndices = [];

            // 1. Find indices that haven't been seen yet
            for(let i=0; i < dbQuestionPool.length; i++) {
                if(!seenIndices.has(i)) {
                    availableIndices.push(i);
                }
            }

            // 2. If not enough fresh questions, reset the tracker (Unlimited cycle)
            if (availableIndices.length < size) {
                seenIndices.clear();
                availableIndices = dbQuestionPool.map((_, i) => i);
                showToast("Pool reshuffled for infinite review", "warning");
            }

            // 3. Shuffle available indices
            availableIndices.sort(() => Math.random() - 0.5);

            // 4. Pick set size (cap at available if somehow lower, though checked above)
            const countToPick = Math.min(size, availableIndices.length);
            const selectedIndices = availableIndices.slice(0, countToPick);

            // 5. Build the quiz set
            activeQuizSet = selectedIndices.map(index => {
                seenIndices.add(index);
                let q = {...dbQuestionPool[index]}; 
                q.choices = [...q.choices].sort(() => Math.random() - 0.5);
                return q;
            });
            
            currentQuestionIndex = 0;
            score = 0;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= activeQuizSet.length) {
                showResultAndBreak();
            } else {
                renderQuestion(currentQuestionIndex);
            }
        }

        // =======================================================
        // RESULT & BREAK SEQUENCE (UPDATED FOR SELECTION)
        // =======================================================
        function showResultAndBreak() {
            const quizDiv = document.getElementById('view-quiz');
            let breakTime = 30; // 30 Seconds Break
            
            const isPassed = score >= (activeQuizSet.length * 0.6); // 60% Passing
            const statusText = isPassed ? "PASSED" : "FAILED";
            const statusColor = isPassed ? "var(--success)" : "var(--error)";

            quizDiv.innerHTML = `
                <div class="card fade-in" style="text-align: center; max-width: 600px; margin: 40px auto; padding: 40px;">
                    <div style="font-size: 1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">SET RESULT</div>
                    
                    <div class="result-badge" style="color: ${statusColor}">
                        ${statusText}
                    </div>

                    <div style="font-size: 1.5rem; margin-bottom: 16px;">
                        Score: <strong>${score} / ${activeQuizSet.length}</strong>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--border-color); margin: 20px 0;">

                    <div style="margin-bottom:10px; font-weight:600;">SELECT NEXT SET SIZE</div>
                    
                    <div class="set-selector" id="set-buttons">
                        <button class="btn btn-outline" data-size="5">5 Qs</button>
                        <button class="btn btn-outline" data-size="10">10 Qs</button>
                        <button class="btn btn-outline" data-size="50">50 Qs</button>
                        <button class="btn btn-outline" data-size="100">100 Qs</button>
                    </div>

                    <div style="background: var(--bg-input); padding: 16px; border-radius: var(--radius-md); margin-top: 30px;">
                        <div class="flex justify-between" style="font-size: 0.8rem; margin-bottom: 8px;">
                            <span>AUTO PROCEED IN (DEFAULT: ${currentSetSize} Qs)</span>
                            <span id="break-timer-text" class="text-mono text-primary font-bold">00:30</span>
                        </div>
                        <div class="countdown-bar">
                            <div id="countdown-fill" class="countdown-fill"></div>
                        </div>
                    </div>
                </div>
            `;

            // Button Logic
            const buttons = document.querySelectorAll('#set-buttons button');
            buttons.forEach(btn => {
                // Highlight current default
                if(parseInt(btn.dataset.size) === currentSetSize) btn.classList.add('active');

                btn.addEventListener('click', () => {
                    clearInterval(breakInterval);
                    currentSetSize = parseInt(btn.dataset.size);
                    startQuizSequence(); // Start immediately
                });
            });

            // Timer Logic
            clearInterval(breakInterval);
            const timerText = document.getElementById('break-timer-text');
            const filler = document.getElementById('countdown-fill');
            const totalTime = 30; // Total break duration

            breakInterval = setInterval(() => {
                breakTime--;
                const min = Math.floor(breakTime / 60).toString().padStart(2,'0');
                const sec = (breakTime % 60).toString().padStart(2,'0');
                
                if(timerText) timerText.innerText = `${min}:${sec}`;
                
                const percentage = (breakTime / totalTime) * 100;
                if(filler) filler.style.width = `${percentage}%`;

                if (breakTime <= 0) {
                    clearInterval(breakInterval);
                    // Auto start with last known size
                    startQuizSequence();
                }
            }, 1000);
        }

        // =======================================================
        // RENDERING (1 Minute Timer + Source Link)
        // =======================================================
        function renderQuestion(index) {
          const quizDiv = document.getElementById('view-quiz');
          const q = activeQuizSet[index];
          
          quizDiv.innerHTML = `
            <div class="card fade-in" style="padding: 24px; max-width: 650px; margin: 0 auto;">
              <div class="flex justify-between items-center" style="margin-bottom: 12px;">
                 <span class="text-muted text-mono text-xs">QUESTION ${index + 1} OF ${activeQuizSet.length}</span>
                 <span class="text-mono text-xs" style="color: var(--text-muted)">CURRENT SCORE: <span class="text-white">${score}</span></span>
              </div>

              <h2 class="text-primary" style="margin-bottom: 24px; font-size: 1.2rem; line-height: 1.5;">
                ${q.question}
              </h2>

              <form id="quiz-form">
                ${q.choices.map(choice =>
                  `<label style="display:flex; align-items:center; padding: 12px; margin-bottom: 10px; cursor:pointer; background: var(--bg-input); border-radius: var(--radius-sm); border: 1px solid transparent; transition:0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'">
                    <input type="radio" name="answer" value="${choice}" required style="margin-right: 12px; accent-color: var(--primary);"/>
                    ${choice}
                  </label>`
                ).join('')}
                <button type="submit" class="btn btn-primary" style="margin-top: 16px; width: 100%;">SUBMIT ANSWER</button>
              </form>

              <div id="quiz-feedback" style="margin-top: 24px; font-size: 0.95rem; line-height: 1.5;"></div>

              <div style="margin-top:20px; border-top: 1px solid var(--border-color); padding-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                 <span class="text-muted text-xs">TIMER</span>
                 <span id="question-timer" class="text-mono font-bold text-error">01:00</span>
              </div>
            </div>
          `;

          const form = document.getElementById('quiz-form');
          const feedback = document.getElementById('quiz-feedback');
          const timerEl = document.getElementById('question-timer');

          clearInterval(questionTimerInterval);
          // 1 MINUTE TIMER
          let timeRemaining = 60; 
          timerEl.textContent = formatTime(timeRemaining);

          questionTimerInterval = setInterval(() => {
            timeRemaining--;
            timerEl.textContent = formatTime(timeRemaining);
            if (timeRemaining <= 0) {
              clearInterval(questionTimerInterval);
              handleTimeUp(q, form, feedback);
            }
          }, 1000);

          form.addEventListener('submit', (e) => {
            e.preventDefault();
            clearInterval(questionTimerInterval);
            const chosen = form.answer.value;
            disableForm(form);

            let isCorrect = (chosen === q.answer);
            if (isCorrect) score++;

            displayFeedback(isCorrect, q, feedback);

            // 5 second delay to read rationale before next question
            setTimeout(() => {
              nextQuestion();
            }, 5000); 
          });
        }

        function handleTimeUp(q, form, feedback) {
            disableForm(form);
            feedback.innerHTML = `<div style="padding: 16px; background: var(--error-bg); border: 1px solid var(--error); border-radius: 8px; color: var(--error);">
                <strong>TIME'S UP!</strong>
            </div>`;
            setTimeout(() => nextQuestion(), 3000);
        }

        function displayFeedback(isCorrect, q, feedbackEl) {
            const colorClass = isCorrect ? 'text-success' : 'text-error';
            const bgClass = isCorrect ? 'var(--success-bg)' : 'var(--error-bg)';
            const borderClass = isCorrect ? 'var(--success)' : 'var(--error)';
            const title = isCorrect ? 'CORRECT ANSWER' : 'INCORRECT';

            // ADDED SOURCE LINK
            feedbackEl.innerHTML = `
                <div class="fade-in" style="padding: 16px; background: ${bgClass}; border: 1px solid ${borderClass}; border-radius: 8px;">
                    <div class="${colorClass} font-bold" style="margin-bottom: 8px;">${title}</div>
                    <div style="margin-bottom: 8px;">Correct Answer: <strong>${q.answer}</strong></div>
                    <p class="text-muted" style="font-size: 0.85rem;">${q.rationale}</p>
                    <div class="source-link">Source: ${q.reference || 'General Nursing Knowledge'}</div>
                </div>
            `;
        }

        // =======================================================
        // UTILITIES & AUTH
        // =======================================================
        const loginBtn = document.getElementById('btn-login');
        const inpUser = document.getElementById('inp-user');
        const inpPass = document.getElementById('inp-pass');
        document.getElementById('btn-seed-data').addEventListener('click', seedDatabase);

        function formatTime(sec) {
          const m = Math.floor(sec / 60).toString().padStart(2, '0');
          const s = (sec % 60).toString().padStart(2, '0');
          return `${m}:${s}`;
        }

        function disableForm(form) {
          Array.from(form.elements).forEach(elem => elem.disabled = true);
          const btn = form.querySelector('button[type="submit"]');
          if (btn) { btn.innerText = "PROCESSING..."; btn.disabled = true; }
        }

        function showView(viewId) {
            ['view-login', 'view-admin', 'view-quiz'].forEach(id => {
                const el = document.getElementById(id);
                if (id === viewId) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        function showToast(msg, type = "primary") {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.innerText = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // =======================================================
        // AUTH STATE & INITIALIZATION
        // =======================================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // resetInactivityTimer(); // Simplified: removed for code brevity in response
                const userRef = doc(db, "users", user.uid);
                
                if(window.userDocUnsub) window.userDocUnsub();
                window.userDocUnsub = onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();

                        if (userData.isBlocked) {
                            handleLogout();
                            return;
                        }

                        if (userData.role === 'admin') {
                            showView('view-admin');
                            document.getElementById('display-username').innerText = "ADMINISTRATOR";
                            initAdminTable();
                        } else {
                            showView('view-quiz');
                            document.getElementById('display-username').innerText = userData.username;
                            // Start Quiz only if not already started
                            if(activeQuizSet.length === 0) {
                                startQuizSequence();
                            }
                        }
                    } else {
                        setDoc(userRef, {
                            username: user.email.split('@')[0],
                            role: 'user',
                            isBlocked: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                });
            } else {
                showView('view-login');
                document.getElementById('display-username').innerText = "Guest";
            }
        });

        loginBtn.addEventListener('click', async () => {
            const user = inpUser.value.trim();
            const pass = inpPass.value;
            if (!user || !pass) return showToast("Enter details", "warning");
            
            const email = user.includes('@') ? user : `${user}@pnle.com`;
            loginBtn.innerText = "AUTHENTICATING...";
            loginBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                showToast("Welcome Back", "success");
            } catch (error) {
                showToast("Invalid Credentials", "error");
                loginBtn.innerText = "START SESSION";
                loginBtn.disabled = false;
            }
        });

        const handleLogout = () => signOut(auth).then(() => window.location.reload());
        document.getElementById('btn-logout').addEventListener('click', handleLogout);
        document.getElementById('btn-admin-logout').addEventListener('click', handleLogout);

        function initAdminTable() {
            const tbody = document.querySelector('#table-users tbody');
            onSnapshot(collection(db, "users"), (snapshot) => {
                tbody.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const uid = docSnap.id;
                    if (data.role === 'admin') return;
                    
                    const statusBadge = data.isBlocked 
                        ? `<span class="text-error font-bold">BLOCKED</span>` 
                        : `<span class="text-success">ACTIVE</span>`;
                    
                    const toggleBtn = data.isBlocked
                        ? `<button class="btn btn-action btn-success" onclick="window.unblockUser('${uid}')">UNBLOCK</button>`
                        : `<button class="btn btn-action btn-warning" onclick="window.blockUser('${uid}')">BLOCK</button>`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><div class="font-bold">${data.username}</div><div class="text-muted" style="font-size:0.75rem">${uid}</div></td>
                        <td>${statusBadge}</td>
                        <td class="text-mono text-muted" style="font-size:0.7rem">ENCRYPTED</td>
                        <td>${toggleBtn} <button class="btn btn-action btn-danger" onclick="window.deleteUser('${uid}')">RESET</button></td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        window.blockUser = async (uid) => { if(confirm("Block?")) await updateDoc(doc(db, "users", uid), { isBlocked: true }); };
        window.unblockUser = async (uid) => { await updateDoc(doc(db, "users", uid), { isBlocked: false }); };
        window.deleteUser = async (uid) => { if(confirm("Reset?")) await updateDoc(doc(db, "users", uid), { isBlocked: true, username: "DELETED_USER" }); };

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
    </script>
</body>
</html>
