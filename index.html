<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PNLE PRO | REAL-TIME SECURE SYSTEM</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>

    <style>
        /* ==================================================================================
           THEME & VARIABLES
           ================================================================================== */
        :root {
            --bg-body: #09090b;
            --bg-card: #18181b;
            --bg-input: #27272a;
            --border-color: #3f3f46;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --primary: #06b6d4; 
            --primary-hover: #0891b2; 
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.15);
            --radius-sm: 6px;
            --radius-md: 12px;
            --container-width: 1280px;
            --font-main: "Inter", sans-serif;
            --font-mono: "JetBrains Mono", monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; scroll-behavior: smooth; }
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            font-size: 16px;
            overflow-x: hidden;
            padding-bottom: 50px;
        }

        /* LAYOUT & UTILS */
        .wrapper { max-width: var(--container-width); margin: 0 auto; padding: 24px; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-4 { gap: 16px; }
        .hidden { display: none !important; }
        .text-mono { font-family: var(--font-mono); }
        .text-primary { color: var(--primary); }
        .text-error { color: var(--error); }
        .text-success { color: var(--success); }
        .text-muted { color: var(--text-muted); }
        .font-bold { font-weight: 700; }
        
        /* COMPONENTS */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 24px; border-radius: var(--radius-sm); font-weight: 600;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
            font-family: var(--font-main); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-primary { background-color: var(--primary); color: #000; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--bg-input); color: var(--text-main); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-action { padding: 4px 8px; font-size: 0.7rem; margin-right: 4px; border-radius: 4px; }
        .btn-danger { background: var(--error-bg); color: var(--error); border: 1px solid var(--error); }
        .btn-warning { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--warning); }
        .btn-success { background: var(--success-bg); color: var(--success); border: 1px solid var(--success); }

        .input {
            width: 100%; padding: 14px 16px; background-color: var(--bg-input);
            border: 1px solid var(--border-color); border-radius: var(--radius-sm);
            color: var(--text-main); font-family: var(--font-main); outline: none;
        }
        .input:focus { border-color: var(--primary); }

        .card {
            background-color: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: var(--radius-md); padding: 32px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .grid-layout {
            display: grid; grid-template-columns: 1fr 350px; gap: 32px; margin-top: 32px;
        }
        @media (max-width: 968px) { .grid-layout { grid-template-columns: 1fr; } }

        /* HEADER */
        .header { border-bottom: 1px solid var(--border-color); padding-bottom: 24px; margin-bottom: 24px; }
        .brand-logo { font-family: var(--font-mono); font-size: 1.5rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .system-status { background: rgba(255,255,255,0.03); padding: 6px 16px; border-radius: 50px; border: 1px solid var(--border-color); font-size: 0.8rem; }
        .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--success); margin-right: 6px; }

        /* ADMIN TABLE */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { text-align: left; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; text-transform: uppercase; }
        .data-table td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .data-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* TOAST */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 16px 24px;
            background: var(--bg-card); border: 1px solid var(--border-color); border-left: 4px solid var(--primary);
            border-radius: var(--radius-sm); transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000; font-weight: 600; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: var(--error); }
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }

        /* ANIMATION */
        .fade-in { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CIRCULAR TIMER FOR BREAK */
        .timer-circle {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--bg-input);
            display: grid; place-items: center; font-size: 2rem; font-weight: 800; font-family: var(--font-mono);
            color: var(--primary); margin: 0 auto 20px auto; position: relative;
        }
        .timer-circle::after {
            content: ''; position: absolute; inset: -4px; border-radius: 50%;
            border: 4px solid var(--primary); border-left-color: transparent; border-bottom-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    </style>
</head>

<body>
    <div id="toast" class="toast">
        <div id="toast-msg">Notification Message</div>
    </div>

    <div class="wrapper">
        <header class="header flex justify-between items-center">
            <div class="brand-logo">
                <span class="text-primary">PNLE</span> PRO <span style="font-size: 0.8rem; margin-left: 10px; color: var(--text-muted); font-weight: 400;">ENTERPRISE</span>
            </div>
            <div class="system-status">
                <span class="status-dot"></span> ONLINE <span style="margin: 0 8px; color: var(--border-color)">|</span> <span id="clock" class="text-mono">00:00:00</span>
            </div>
        </header>

        <main class="grid-layout">
            <section id="main-content">
                
                <div id="view-login" class="card fade-in">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 1.5rem; margin-bottom: 8px;">System Access Login</h2>
                        <p class="text-muted">Enter credentials. Multi-factor device binding is active.</p>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display:block; margin-bottom: 8px; font-size: 0.9rem;" class="text-muted">Username</label>
                        <input type="text" id="inp-user" class="input" placeholder="e.g. admin or student1" autocomplete="off" />
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display:block; margin-bottom: 8px; font-size: 0.9rem;" class="text-muted">Password</label>
                        <input type="password" id="inp-pass" class="input" placeholder="••••••••" />
                    </div>

                    <button id="btn-login" class="btn btn-primary" style="width: 100%;">SECURE LOGIN</button>
                    <p class="text-muted" style="font-size: 0.75rem; margin-top: 20px; text-align: center;">
                        Secured by Firebase Auth & Firestore Real-time DB
                    </p>
                </div>

                <div id="view-admin" class="card fade-in hidden">
                    <div class="flex justify-between items-center" style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <h2 class="text-primary">Admin Control Center</h2>
                            <p class="text-muted" style="font-size: 0.85rem;">Real-time User Management</p>
                        </div>
                        <button id="btn-admin-logout" class="btn btn-secondary text-xs">EXIT ADMIN</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="data-table" id="table-users">
                            <thead>
                                <tr>
                                    <th>Username / Email</th>
                                    <th>Status</th>
                                    <th>Security Hash</th>
                                    <th>Controls</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="view-quiz" class="hidden fade-in"></div>

            </section>

            <aside class="sidebar fade-in" style="max-width: 350px;">
                <div class="card">
                    <div class="flex items-center gap-4" style="margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; background: var(--bg-input); border-radius: 50%; display: grid; place-items: center; color: var(--primary);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: 0.75rem;">CURRENT SESSION</div>
                            <div id="display-username" class="font-bold text-primary">Guest</div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 10px;">
                            AUTO-LOGOUT PROTECTION: ACTIVE
                        </div>
                        <button id="btn-logout" class="btn btn-secondary" style="width: 100%; font-size: 0.8rem;">LOGOUT SESSION</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script type="module">
        // 1. IMPORT FIREBASE SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // 2. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCmd6vmuXUPslLJf0w7I518C8UIaO2DoAA",
            authDomain: "pnle-class.firebaseapp.com",
            projectId: "pnle-class",
            storageBucket: "pnle-class.firebasestorage.app",
            messagingSenderId: "1024768890816",
            appId: "1:1024768890816:web:28bf31d5ae67c679feda25",
            measurementId: "G-JLS5ZGFP3J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =======================================================
        // AUTO LOGOUT LOGIC (INACTIVITY)
        // =======================================================
        const INACTIVITY_LIMIT = 5 * 60 * 1000; // 5 Minutes (adjust as needed)
        let inactivityTimer;

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            // Only set timer if user is actually logged in
            if (auth.currentUser) {
                inactivityTimer = setTimeout(() => {
                    alert("System Notice: You have been logged out due to inactivity.");
                    handleLogout();
                }, INACTIVITY_LIMIT);
            }
        }

        // Listen for user activity events
        window.onload = resetInactivityTimer;
        document.onmousemove = resetInactivityTimer;
        document.onkeypress = resetInactivityTimer;
        document.ontouchstart = resetInactivityTimer;
        document.onclick = resetInactivityTimer;


        // =======================================================
        // QUIZ DATA & LOGIC
        // =======================================================
        
        // This is the "Pool" of questions. Add as many as you want here.
        // The system will randomly pick 5 from this list every cycle.
        const questionPool = [
          {
            question: "What is the legal age requirement to take the Philippine Nursing Board Exam?",
            choices: ["18 years old", "21 years old", "17 years old", "20 years old"],
            answer: "18 years old",
            rationale: "By law, a nursing candidate must be at least 18 years old to qualify for the board exam.",
            reference: "https://www.prc.gov.ph/licensure-examination"
          },
          {
            question: "Which government agency administers the Philippine Nursing Board Exam?",
            choices: ["Professional Regulation Commission (PRC)", "Department of Health (DOH)", "Philippine Nurses Association", "Commission on Higher Education (CHED)"],
            answer: "Professional Regulation Commission (PRC)",
            rationale: "The PRC is responsible for licensing and regulation of nursing professionals in the Philippines.",
            reference: "https://www.prc.gov.ph"
          },
          {
            question: "How many years of nursing education is required to qualify for the Philippine Nursing Board Exam?",
            choices: ["3 years", "4 years", "5 years", "2 years"],
            answer: "4 years",
            rationale: "A bachelor's degree in nursing, which is typically 4 years, is required.",
            reference: "https://ched.gov.ph"
          },
          {
            question: "What is the minimum passing score for the Philippine Nursing Board Exam?",
            choices: ["75%", "80%", "70%", "85%"],
            answer: "75%",
            rationale: "To pass, examinees must obtain at least 75% overall.",
            reference: "https://www.prc.gov.ph/licensure-examination"
          },
          {
            question: "How many questions are typically included in the Philippine Nursing Board Exam?",
            choices: ["300 questions", "500 questions", "600 questions", "400 questions"],
            answer: "500 questions",
            rationale: "The exam usually consists of 500 multiple-choice questions covering nursing subjects.",
            reference: "https://www.prc.gov.ph/licensure-examination"
          },
          {
             question: "Which is the primary prevention against Hepatitis B?",
             choices: ["Vaccination", "Antibiotics", "Physical Therapy", "Isolation"],
             answer: "Vaccination",
             rationale: "Hepatitis B vaccination is the most effective way to prevent infection.",
             reference: "https://doh.gov.ph"
          },
          {
             question: "In the nursing process, what comes after Assessment?",
             choices: ["Planning", "Diagnosis", "Implementation", "Evaluation"],
             answer: "Diagnosis",
             rationale: "The standard nursing process is Assessment, Diagnosis, Planning, Implementation, Evaluation (ADPIE).",
             reference: "https://nursingworld.org"
          }
        ];

        let activeQuizSet = []; // Stores the current 5 questions
        let currentQuestionIndex = 0;
        let score = 0;
        let questionTimerInterval;
        let breakInterval;

        // Function to pick 5 random questions
        function generateNewQuizSet() {
            // Shuffle the entire pool
            let shuffled = [...questionPool].sort(() => 0.5 - Math.random());
            // Take the first 5
            activeQuizSet = shuffled.slice(0, 5);
            
            // Shuffle choices inside the questions
            for(let q of activeQuizSet){
                q.choices = q.choices.sort(() => Math.random() - 0.5);
            }
            
            currentQuestionIndex = 0;
            score = 0;
        }

        // Logic to move to next question or start break
        function nextQuestion() {
            currentQuestionIndex++;
            
            // Check if we finished the set of 5
            if (currentQuestionIndex >= activeQuizSet.length) {
                startBreakSequence();
            } else {
                renderQuestion(currentQuestionIndex);
            }
        }

        // THE BREAK SEQUENCE (1 Minute Countdown)
        function startBreakSequence() {
            const quizDiv = document.getElementById('view-quiz');
            let breakTime = 60; // 60 Seconds Break

            quizDiv.innerHTML = `
                <div class="card fade-in" style="text-align: center; max-width: 600px; margin: 40px auto; padding: 40px;">
                    <h2 class="text-primary" style="margin-bottom: 20px;">SET COMPLETED</h2>
                    <p class="text-muted" style="margin-bottom: 30px;">
                        Good job! Taking a short break before the next set of questions loads.
                    </p>
                    
                    <div class="timer-circle" id="break-display">
                        ${breakTime}
                    </div>

                    <p style="font-size: 0.9rem;">
                        Preparing new random questions...
                    </p>
                </div>
            `;

            clearInterval(breakInterval);
            const breakDisplay = document.getElementById('break-display');

            breakInterval = setInterval(() => {
                breakTime--;
                if(breakDisplay) breakDisplay.innerText = breakTime;

                if (breakTime <= 0) {
                    clearInterval(breakInterval);
                    generateNewQuizSet(); // Generate NEW questions
                    renderQuestion(0); // Start index 0
                }
            }, 1000);
        }

        function renderQuestion(index) {
          const quizDiv = document.getElementById('view-quiz');
          const q = activeQuizSet[index];
          const totalQ = activeQuizSet.length;

          quizDiv.innerHTML = `
            <div class="card fade-in" style="padding: 24px; max-width: 650px; margin: 0 auto;">
              <div class="flex justify-between items-center" style="margin-bottom: 12px;">
                 <span class="text-muted text-mono text-xs">QUESTION ${index + 1} OF ${totalQ}</span>
                 <span class="text-success text-mono text-xs">SCORE: ${score}</span>
              </div>

              <h2 class="text-primary" style="margin-bottom: 24px; font-size: 1.2rem; line-height: 1.5;">
                ${q.question}
              </h2>

              <form id="quiz-form">
                ${q.choices.map(choice =>
                  `<label style="display:flex; align-items:center; padding: 12px; margin-bottom: 10px; cursor:pointer; background: var(--bg-input); border-radius: var(--radius-sm); border: 1px solid transparent; transition:0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'">
                    <input type="radio" name="answer" value="${choice}" required style="margin-right: 12px; accent-color: var(--primary);"/>
                    ${choice}
                  </label>`
                ).join('')}
                <button type="submit" class="btn btn-primary" style="margin-top: 16px; width: 100%;">SUBMIT ANSWER</button>
              </form>

              <div id="quiz-feedback" style="margin-top: 24px; font-size: 0.95rem; line-height: 1.5;"></div>

              <div style="margin-top:20px; border-top: 1px solid var(--border-color); padding-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                 <span class="text-muted text-xs">ANSWER TIMER</span>
                 <span id="question-timer" class="text-mono font-bold text-error">03:00</span>
              </div>
            </div>
          `;

          const form = document.getElementById('quiz-form');
          const feedback = document.getElementById('quiz-feedback');
          const timerEl = document.getElementById('question-timer');

          // Question Timer (3 minutes per question limit)
          clearInterval(questionTimerInterval);
          let timeRemaining = 180;
          timerEl.textContent = formatTime(timeRemaining);

          questionTimerInterval = setInterval(() => {
            timeRemaining--;
            timerEl.textContent = formatTime(timeRemaining);
            if (timeRemaining <= 0) {
              clearInterval(questionTimerInterval);
              handleTimeUp(q, form, feedback);
            }
          }, 1000);

          form.addEventListener('submit', (e) => {
            e.preventDefault();
            clearInterval(questionTimerInterval);
            const chosen = form.answer.value;
            disableForm(form);

            let isCorrect = (chosen === q.answer);
            if (isCorrect) score++;

            displayFeedback(isCorrect, q, feedback);

            // Wait 5 seconds (fast feedback) then go next
            setTimeout(() => {
              nextQuestion();
            }, 5000); 
          });
        }

        function handleTimeUp(q, form, feedback) {
            disableForm(form);
            feedback.innerHTML = `<div style="padding: 16px; background: var(--error-bg); border: 1px solid var(--error); border-radius: 8px; color: var(--error);">
                <strong>TIME'S UP!</strong>
            </div>`;
            setTimeout(() => nextQuestion(), 3000);
        }

        function displayFeedback(isCorrect, q, feedbackEl) {
            const colorClass = isCorrect ? 'text-success' : 'text-error';
            const bgClass = isCorrect ? 'var(--success-bg)' : 'var(--error-bg)';
            const borderClass = isCorrect ? 'var(--success)' : 'var(--error)';
            const title = isCorrect ? 'CORRECT ANSWER' : 'INCORRECT';

            feedbackEl.innerHTML = `
                <div class="fade-in" style="padding: 16px; background: ${bgClass}; border: 1px solid ${borderClass}; border-radius: 8px;">
                    <div class="${colorClass} font-bold" style="margin-bottom: 8px;">${title}</div>
                    <div style="margin-bottom: 8px;">Correct Answer: <strong>${q.answer}</strong></div>
                    <p class="text-muted" style="font-size: 0.85rem;">${q.rationale}</p>
                </div>
            `;
        }

        // =======================================================
        // UTILITIES & AUTH
        // =======================================================

        const loginBtn = document.getElementById('btn-login');
        const inpUser = document.getElementById('inp-user');
        const inpPass = document.getElementById('inp-pass');

        function formatTime(sec) {
          const m = Math.floor(sec / 60).toString().padStart(2, '0');
          const s = (sec % 60).toString().padStart(2, '0');
          return `${m}:${s}`;
        }

        function disableForm(form) {
          Array.from(form.elements).forEach(elem => elem.disabled = true);
          const btn = form.querySelector('button[type="submit"]');
          if (btn) {
              btn.innerText = "PROCESSING...";
              btn.disabled = true;
          }
        }

        function showView(viewId) {
            ['view-login', 'view-admin', 'view-quiz'].forEach(id => {
                const el = document.getElementById(id);
                if (id === viewId) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        function showToast(msg, type = "primary") {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.innerText = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // AUTH LISTENER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                resetInactivityTimer(); // Start inactivity watch
                const userRef = doc(db, "users", user.uid);
                
                if(window.userDocUnsub) window.userDocUnsub();
                window.userDocUnsub = onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();

                        if (userData.isBlocked) {
                            handleLogout();
                            return;
                        }

                        if (userData.role === 'admin') {
                            showView('view-admin');
                            document.getElementById('display-username').innerText = "ADMINISTRATOR";
                            initAdminTable();
                        } else {
                            showView('view-quiz');
                            document.getElementById('display-username').innerText = userData.username;
                            // Generate initial set if empty
                            if(activeQuizSet.length === 0) {
                                generateNewQuizSet();
                                renderQuestion(0);
                            }
                        }
                    } else {
                        // Create basic user doc if missing
                        setDoc(userRef, {
                            username: user.email.split('@')[0],
                            role: 'user',
                            isBlocked: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                });

            } else {
                clearTimeout(inactivityTimer); // Stop inactivity watch
                showView('view-login');
                document.getElementById('display-username').innerText = "Guest";
            }
        });

        loginBtn.addEventListener('click', async () => {
            const user = inpUser.value.trim();
            const pass = inpPass.value;

            if (!user || !pass) {
                showToast("Please enter username and password", "warning");
                return;
            }
            const email = user.includes('@') ? user : `${user}@pnle.com`;

            loginBtn.innerText = "AUTHENTICATING...";
            loginBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                showToast("Login Successful", "success");
            } catch (error) {
                console.error(error);
                showToast("Invalid Credentials", "error");
                loginBtn.innerText = "SECURE LOGIN";
                loginBtn.disabled = false;
            }
        });

        const handleLogout = () => signOut(auth).then(() => window.location.reload());
        document.getElementById('btn-logout').addEventListener('click', handleLogout);
        document.getElementById('btn-admin-logout').addEventListener('click', handleLogout);

        // Admin Table Logic
        function initAdminTable() {
            const tbody = document.querySelector('#table-users tbody');
            onSnapshot(collection(db, "users"), (snapshot) => {
                tbody.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const uid = docSnap.id;
                    if (data.role === 'admin') return;
                    
                    const statusBadge = data.isBlocked 
                        ? `<span class="text-error font-bold">BLOCKED</span>` 
                        : `<span class="text-success">ACTIVE</span>`;
                    
                    const toggleBtn = data.isBlocked
                        ? `<button class="btn btn-action btn-success" onclick="window.unblockUser('${uid}')">UNBLOCK</button>`
                        : `<button class="btn btn-action btn-warning" onclick="window.blockUser('${uid}')">BLOCK</button>`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="font-bold">${data.username}</div>
                            <div class="text-muted" style="font-size:0.75rem">${uid}</div>
                        </td>
                        <td>${statusBadge}</td>
                        <td class="text-mono text-muted" style="font-size:0.7rem">SHA256-ENCRYPTED</td>
                        <td>
                            ${toggleBtn}
                            <button class="btn btn-action btn-danger" onclick="window.deleteUser('${uid}')">RESET</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // Expose admin functions globally
        window.blockUser = async (uid) => {
            if(confirm("Block this user?")) await updateDoc(doc(db, "users", uid), { isBlocked: true });
        };
        window.unblockUser = async (uid) => {
            await updateDoc(doc(db, "users", uid), { isBlocked: false });
        };
        window.deleteUser = async (uid) => {
            if(confirm("Reset this user?")) await updateDoc(doc(db, "users", uid), { isBlocked: true, username: "DELETED_USER" });
        };

        // Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB');
        }, 1000);

    </script>
</body>
</html>
